name: GetDataBase
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  # star and watch events
  watch:
    types: [started]
    

jobs:
  builds:
    name: GetDataBase
    runs-on: ubuntu-latest
    steps:
      - name: Check out source code
        uses: actions/checkout@v3

      - name: 'Set up Python'
        uses: actions/setup-python@v1
        with:
           python-version: 3.7

      - name: 'Install requirements'
        run: |
          pip install -r ./requirements.txt

      - name: 'Run Bing API'
        env:
          PASSWORD: ${{ secrets.PASSWORD }}
        run: python ./main.py

      - name: "POST to Redis"
        env:
          PASSWORD: ${{ secrets.PASSWORD }}
        run: python ./post_to_redis.py
          
      # check it to your workflow can access it
      # from: https://github.com/actions/checkout
      - name: Checkout Repository master branch
        uses: actions/checkout@master 
        
      - name: Setup Git Infomation
        run: | 
          git config --global user.name 'zkeq' 
          git config --global user.email 'admin@icodeq.com'  
          
      - name: Setup SSH Private Key
        env:
          token_Private_Keys: ${{ secrets.token_Private_Keys }}
        run: |
          mkdir -p ~/.ssh/
          echo "$token_Private_Keys" > ~/.ssh/id_rsa 
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts
      
      - name: Get Latest Commit Message 
        run: |
          git log --pretty=format:"%s from Github Actions at `date +"%Y-%m-%d %H:%M:%S"`" --date=short -n 1  > commit-message.log
      
      - name: Backup To Gitee Private Project
        env:
          Gitee_Blog: github.com:zkeq/Bing-Wallpaper-Action.git
        run: |
          git add .
          git push --force --quiet "git@${Gitee_Blog}"
